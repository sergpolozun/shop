{% extends "main/base.html" %}
{% load static %}
{% load mytags %}

{% block title %}Магазин | POLOS{% endblock %}

{% block content %}
<div class="shop-container">
  <div class="shop-header">
    <span>Магазин стритвир одежды POLOS</span>
  </div>

  <!-- Навигационная панель -->
  <div class="shop-nav">
    <div class="shop-nav-left">
      <button class="btn-win98" onclick="openCategories()">Категории</button>
      <button class="btn-win98" onclick="openFilter()">Фильтрация</button>
    </div>
    
    <div class="shop-nav-center">
      {% if page_obj.has_other_pages %}
        <div class="pagination-info">
          <span>Страница {{ page_obj.number }} из {{ page_obj.paginator.num_pages }}</span>
          <div class="pagination-controls">
            {% if page_obj.has_previous %}
              <button class="btn-win98" onclick="goToPage({{ page_obj.previous_page_number }})">←</button>
            {% endif %}
            
            {% for num in page_obj.paginator.page_range %}
              {% if page_obj.number == num %}
                <span class="current-page">{{ num }}</span>
              {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <button class="btn-win98" onclick="goToPage({{ num }})">{{ num }}</button>
              {% endif %}
            {% endfor %}
            
            {% if page_obj.has_next %}
              <button class="btn-win98" onclick="goToPage({{ page_obj.next_page_number }})">→</button>
            {% endif %}
          </div>
        </div>
      {% endif %}
    </div>
    
    <div class="shop-nav-right">
      <button class="btn-win98" onclick="window.location.href='{% url 'shop:favorite_list' %}'">Избранное</button>
  {% if user.is_authenticated %}
      <form method="post" action="{% url 'logout' %}" style="display:inline;">
        {% csrf_token %}
          <button type="submit" class="btn-win98">Выйти</button>
      </form>
        <button class="btn-win98" onclick="window.location.href='{% url 'shop:cart' %}'">Корзина</button>
  {% else %}
        <button class="btn-win98" onclick="window.location.href='{% url 'login' %}'">Войти</button>
  {% endif %}
    </div>
  </div>

  <!-- Список товаров -->
  <section class="product-list" aria-label="Список товаров">
    {% for product in products %}
      <article class="product-card{% if product.id in favorite_ids %} favorite-product{% endif %}" onclick="openProductModal({{ product.id }})">
        <div class="product-image">
        {% if product.image %}
          <img src="{{ product.image.url }}" alt="{{ product.name }}">
        {% else %}
          <img src="{% static 'img/notfound.jpg' %}" alt="Изображение не найдено">
        {% endif %}
        </div>

        <div class="product-info">
          <h3>{{ product.name|truncatewords:3 }}</h3>
          <p class="product-date">Добавлено: {{ product.created_at|date:"d.m.Y" }}</p>

        {% if product.discount %}
            <div class="product-price">
            <span class="old-price">{{ product.price }}₽</span>
            <span class="discount-price">{{ product.discount_price }}₽</span>
              <span class="discount-badge">-{{ product.discount }}%</span>
            </div>
        {% else %}
            <div class="product-price">
              <span class="current-price">{{ product.price }}₽</span>
            </div>
        {% endif %}
        </div>
      </article>
    {% endfor %}
  </section>
</div>

<!-- Модальное окно товара -->
<div id="productModal" class="modal-win98">
    <div class="modal-content-win98">
        <div class="modal-header-win98">
            <h3 id="modalTitle">Детали товара</h3>
            <button class="close-btn-win98" onclick="closeProductModal()">×</button>
        </div>
        <div class="modal-body-win98" id="modalBody">
            <!-- Контент будет загружен через AJAX -->
        </div>
    </div>
</div>

<!-- Модальное окно категорий -->
<div id="categoriesModal" class="modal-win98">
    <div class="modal-content-win98">
        <div class="modal-header-win98">
            <h3>Выберите категорию</h3>
            <button class="close-btn-win98" onclick="closeCategories()">×</button>
        </div>
        <div class="modal-body-win98">
            <div class="category-item" data-category="all" onclick="selectCategory('all')">
                Все категории
            </div>
            {% for category in categories %}
            <div class="category-item" data-category="{{ category.id }}" onclick="selectCategory({{ category.id }})">
                {{ category.name }}
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Модальное окно фильтрации -->
<div id="filterModal" class="modal-win98">
    <div class="modal-content-win98">
        <div class="modal-header-win98">
            <h3>Фильтрация товаров</h3>
            <button class="close-btn-win98" onclick="closeFilter()">×</button>
        </div>
        <div class="modal-body-win98">
            <form id="filterForm">
                <div class="filter-section">
                    <h4>Сортировка по:</h4>
                    <div class="radio-group">
                        <label class="radio-item">
                            <input type="radio" name="sort" value="popularity" {% if current_sort == 'popularity' %}checked{% endif %}>
                            <span class="radio-custom"></span>
                            Популярности
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="sort" value="price" {% if current_sort == 'price' %}checked{% endif %}>
                            <span class="radio-custom"></span>
                            Цене
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="sort" value="date" {% if current_sort == 'date' %}checked{% endif %}>
                            <span class="radio-custom"></span>
                            Дате
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="sort" value="name" {% if current_sort == 'name' %}checked{% endif %}>
                            <span class="radio-custom"></span>
                            Названию
                        </label>
                    </div>
                </div>
                
                <div class="filter-section">
                    <h4>Порядок сортировки:</h4>
                    <div class="radio-group">
                        <label class="radio-item">
                            <input type="radio" name="order" value="desc" {% if current_order == 'desc' %}checked{% endif %}>
                            <span class="radio-custom"></span>
                            Убывание
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="order" value="asc" {% if current_order == 'asc' %}checked{% endif %}>
                            <span class="radio-custom"></span>
                            Возрастание
                        </label>
                    </div>
  </div>

                <div class="filter-section">
                    <h4>Диапазон цен:</h4>
                    <div class="price-range">
                        <div class="price-input-group">
                            <label>От:</label>
                            <input type="number" name="min_price" id="minPrice" 
                                   placeholder="0" 
                                   value="{{ current_min_price|default:'' }}"
                                   min="0" 
                                   step="1"
                                   class="price-input">
                        </div>
                        <div class="price-input-group">
                            <label>До:</label>
                            <input type="number" name="max_price" id="maxPrice" 
                                   placeholder="{{ price_stats.max_price|default:'10000' }}" 
                                   value="{{ current_max_price|default:'' }}"
                                   min="0" 
                                   step="1"
                                   class="price-input">
                        </div>
                    </div>
                </div>
                
                <div class="filter-buttons">
                    <button type="submit" class="btn-win98">Применить</button>
                    <button type="button" class="btn-win98" onclick="resetFilter()">Сбросить</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script src="{% static 'js/list.js' %}"></script>
<script src="{% static 'js/cart.js' %}"></script>
{% endblock %}
